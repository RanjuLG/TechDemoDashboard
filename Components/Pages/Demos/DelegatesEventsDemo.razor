@page "/demos/delegates-events"
@using TechDemoDashboard.Services
@rendermode InteractiveServer

<PageTitle>Delegates & Events Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1400px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">üìä</span>Delegates & Events - Stock Market
            </h1>
            <p class="text-secondary-custom">
                Watch how the <strong class="text-white">Publisher/Subscriber pattern</strong> works with delegates and events.
                The Stock Exchange fires price change events, and traders automatically respond!
            </p>
        </div>

        <div class="row g-4">
            <!-- Left Column: Stock Exchange & Concepts -->
            <div class="col-lg-6">
                <!-- Stock Exchange Panel -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <div class="text-center p-4 rounded mb-4" style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(78, 205, 196, 0.1));">
                            <div class="h4 fw-bold text-info mb-2">@Service.Exchange.Symbol</div>
                            <div class="display-4 fw-bold text-primary-custom mb-3">$@Service.Exchange.CurrentPrice.ToString("F2")</div>
                            <button class="btn btn-primary btn-lg px-4" @onclick="ChangePrice">
                                <span class="me-2">üîÑ</span>Change Price
                            </button>
                        </div>

                        <div class="alert alert-info border-info">
                            <h3 class="h6 fw-bold mb-2">üìå The Publisher</h3>
                            <p class="mb-2 small"><code>StockExchange</code> has an <strong>event</strong> that fires when price changes.</p>
                            <pre class="mb-2"><code>public event PriceChangedHandler? OnPriceChanged;</code></pre>
                            <p class="mb-0 small text-warning"><em>Only the owner can <code>Invoke()</code> the event!</em></p>
                        </div>
                    </div>
                </div>

                <!-- Key Concepts -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="h5 mb-0 fw-bold">üí° Key Concepts</h2>
                    </div>
                    <div class="card-body p-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 border border-secondary rounded">
                                    <h3 class="h6 fw-bold text-info mb-2">üéØ Delegate</h3>
                                    <p class="small text-secondary-custom mb-2">A <strong>type-safe function pointer</strong>. Defines the signature for methods.</p>
                                    <pre class="mb-0"><code class="small">public delegate void PriceChangedHandler(object sender, PriceChangedEventArgs e);</code></pre>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 border border-secondary rounded">
                                    <h3 class="h6 fw-bold text-info mb-2">üîî Event</h3>
                                    <p class="small text-secondary-custom mb-2">A <strong>protected delegate</strong>. Only the publisher can fire it.</p>
                                    <pre class="mb-0"><code class="small">public event PriceChangedHandler? OnPriceChanged;</code></pre>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 border border-secondary rounded">
                                    <h3 class="h6 fw-bold text-info mb-2">‚ûï Subscribe</h3>
                                    <p class="small text-secondary-custom mb-2">Attach a method to an event using <code>+=</code></p>
                                    <pre class="mb-0"><code class="small">exchange.OnPriceChanged += trader.OnPriceChanged;</code></pre>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 border border-secondary rounded">
                                    <h3 class="h6 fw-bold text-info mb-2">‚ûñ Unsubscribe</h3>
                                    <p class="small text-secondary-custom mb-2">Remove a method from an event using <code>-=</code></p>
                                    <pre class="mb-0"><code class="small">exchange.OnPriceChanged -= trader.OnPriceChanged;</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Subscribers & Activity -->
            <div class="col-lg-6">
                <!-- Subscribers Panel -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2 class="h5 mb-0 fw-bold">Active Subscribers</h2>
                    </div>
                    <div class="card-body p-3">
                        <p class="text-secondary-custom small mb-3">Toggle traders on/off to see dynamic subscription (<code>+=</code> and <code>-=</code>)</p>
                        
                        <div class="row g-3">
                            <!-- Bull Trader -->
                            <div class="col-md-6">
                                <div class="card @(Service.IsBullSubscribed ? "border-success" : "border-secondary") h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="fs-4">üêÇ</span>
                                                <span class="fw-bold text-white">@Service.BullTrader.Name</span>
                                            </div>
                                            <button class="btn btn-sm @(Service.IsBullSubscribed ? "btn-outline-danger" : "btn-outline-success")" @onclick="Service.ToggleBull">
                                                @(Service.IsBullSubscribed ? "Unsubscribe" : "Subscribe")
                                            </button>
                                        </div>
                                        <p class="small text-secondary-custom mb-2">Buys when price goes UP ‚¨ÜÔ∏è</p>
                                        @if (Service.IsBullSubscribed)
                                        {
                                            <span class="badge bg-success">‚úÖ Listening</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">‚è∏Ô∏è Inactive</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Bear Trader -->
                            <div class="col-md-6">
                                <div class="card @(Service.IsBearSubscribed ? "border-success" : "border-secondary") h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="fs-4">üêª</span>
                                                <span class="fw-bold text-white">@Service.BearTrader.Name</span>
                                            </div>
                                            <button class="btn btn-sm @(Service.IsBearSubscribed ? "btn-outline-danger" : "btn-outline-success")" @onclick="Service.ToggleBear">
                                                @(Service.IsBearSubscribed ? "Unsubscribe" : "Subscribe")
                                            </button>
                                        </div>
                                        <p class="small text-secondary-custom mb-2">Sells when price goes DOWN ‚¨áÔ∏è</p>
                                        @if (Service.IsBearSubscribed)
                                        {
                                            <span class="badge bg-success">‚úÖ Listening</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">‚è∏Ô∏è Inactive</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Day Trader -->
                            <div class="col-md-6">
                                <div class="card @(Service.IsDayTraderSubscribed ? "border-success" : "border-secondary") h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="fs-4">üìà</span>
                                                <span class="fw-bold text-white">@Service.DayTrader.Name</span>
                                            </div>
                                            <button class="btn btn-sm @(Service.IsDayTraderSubscribed ? "btn-outline-danger" : "btn-outline-success")" @onclick="Service.ToggleDayTrader">
                                                @(Service.IsDayTraderSubscribed ? "Unsubscribe" : "Subscribe")
                                            </button>
                                        </div>
                                        <p class="small text-secondary-custom mb-2">Trades on volatility > 5%</p>
                                        @if (Service.IsDayTraderSubscribed)
                                        {
                                            <span class="badge bg-success">‚úÖ Listening</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">‚è∏Ô∏è Inactive</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- News Alert -->
                            <div class="col-md-6">
                                <div class="card @(Service.IsNewsSubscribed ? "border-success" : "border-secondary") h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="fs-4">üì∞</span>
                                                <span class="fw-bold text-white">@Service.NewsAlert.Source</span>
                                            </div>
                                            <button class="btn btn-sm @(Service.IsNewsSubscribed ? "btn-outline-danger" : "btn-outline-success")" @onclick="Service.ToggleNews">
                                                @(Service.IsNewsSubscribed ? "Unsubscribe" : "Subscribe")
                                            </button>
                                        </div>
                                        <p class="small text-secondary-custom mb-2">Reports all price changes</p>
                                        @if (Service.IsNewsSubscribed)
                                        {
                                            <span class="badge bg-success">‚úÖ Listening</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">‚è∏Ô∏è Inactive</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2 class="h5 mb-0 fw-bold">üìã Activity Log</h2>
                        <button class="btn btn-sm btn-secondary" @onclick="Service.ClearLogs">Clear</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-3 bg-dark rounded" style="max-height: 400px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85rem;">
                            @if (!Service.GlobalActivityLog.Any())
                            {
                                <div class="text-center text-muted py-4">
                                    Click "Change Price" to see events in action!
                                </div>
                            }
                            else
                            {
                                @foreach (var entry in Service.GlobalActivityLog.TakeLast(20).Reverse())
                                {
                                    <div class="text-secondary-custom py-1 border-bottom border-secondary">@entry</div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject]
    private DelegatesEventsService Service { get; set; } = default!;

    private void ChangePrice()
    {
        Service.ChangePrice();
    }
}
