@page "/demos/concurrency"
@using TechDemoDashboard.Components.Shared
@using TechDemoDashboard.Services
@inject ConcurrencyService ConcurrencyService
@rendermode InteractiveServer

<PageTitle>Concurrency Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1000px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">üßµ</span>Concurrency & Parallelism Demo
            </h1>
            <p class="text-secondary-custom">
                Explore the differences between blocking, async, and parallel execution patterns in .NET.
                Watch the log output to see how each approach behaves differently.
            </p>
        </div>

        <!-- Interview Question -->
        <div class="alert alert-info border-info mb-4">
            <div class="mb-2">
                <span class="fw-bold">üéØ Interview Question:</span> 
                <span class="fst-italic">"What's the difference between async/await, Task.WhenAll, and Parallel.ForEach?"</span>
            </div>
            <div class="ms-4">
                <strong>Answer:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>async/await:</strong> Runs tasks sequentially (one after another). Best for I/O operations.</li>
                    <li><strong>Task.WhenAll:</strong> Runs tasks concurrently (starts all at once, waits for all). Best for concurrent I/O operations.</li>
                    <li><strong>Parallel.ForEach:</strong> Uses multiple CPU threads for parallel execution. Best for CPU-intensive tasks.</li>
                </ul>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-danger" @onclick="RunSequential" disabled="@_isBusy">
                        <span class="me-1">üîÑ</span> Sequential (Blocking)
                    </button>
                    
                    <button class="btn btn-info" @onclick="RunAsync" disabled="@_isBusy">
                        <span class="me-1">‚ö°</span> Async (Sequential)
                    </button>
                    
                    <button class="btn btn-warning" @onclick="RunConcurrent" disabled="@_isBusy">
                        <span class="me-1">üî•</span> Concurrent (Task.WhenAll)
                    </button>
                    
                    <button class="btn" style="background: linear-gradient(135deg, #a855f7, #9333ea); color: white;" @onclick="RunParallel" disabled="@_isBusy">
                        <span class="me-1">üöÄ</span> Parallel (CPU)
                    </button>

                    <button class="btn btn-secondary ms-auto" @onclick="ClearLog" disabled="@_isBusy">
                        <span class="me-1">üóëÔ∏è</span> Clear Log
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-3">
                    <label for="parallelism" class="text-white fw-500 mb-0">Max Degree of Parallelism:</label>
                    <input type="range" class="form-range flex-grow-1" style="max-width: 300px;" id="parallelism" min="1" max="16" @bind="_maxDegreeOfParallelism" @bind:event="oninput" disabled="@_isBusy" />
                    <span class="badge bg-purple fs-6 px-3">@_maxDegreeOfParallelism</span>
                </div>
            </div>
        </div>

        <!-- Execution Time Comparison -->
        @if (_executionTimes.Any(kv => kv.Value.HasValue))
        {
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="h6 mb-0 fw-bold">‚è±Ô∏è Execution Time Comparison</h3>
                    <button class="btn btn-sm btn-secondary" @onclick="ResetTimes" disabled="@_isBusy">
                        üîÑ Reset
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Method</th>
                                    <th>Last Run Time</th>
                                    <th>UI Responsive</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in _executionTimes)
                                {
                                    <tr class="@(entry.Value.HasValue ? "" : "text-muted")">
                                        <td>
                                            <span class="me-2">@GetMethodIcon(entry.Key)</span>
                                            @entry.Key
                                        </td>
                                        <td class="font-monospace">
                                            @if (entry.Value.HasValue)
                                            {
                                                <span class="text-primary-custom fw-bold">@entry.Value.Value ms</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">‚Äî</span>
                                            }
                                        </td>
                                        <td>
                                            @if (entry.Key == "Sequential")
                                            {
                                                <span class="badge bg-danger">‚ùå Frozen</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">‚úÖ Yes</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Log Output -->
        <DemoContainer @ref="_demoContainer" Title="Execution Log" IsBusy="@_isBusy" />
    </div>
</div>

@code {
    private DemoContainer? _demoContainer;
    private bool _isBusy;
    private int _maxDegreeOfParallelism = 4;
    
    private Dictionary<string, long?> _executionTimes = new()
    {
        ["Sequential"] = null,
        ["Async"] = null,
        ["Concurrent"] = null,
        ["Parallel"] = null
    };

    private string GetMethodIcon(string method) => method switch
    {
        "Sequential" => "üîÑ",
        "Async" => "‚ö°",
        "Concurrent" => "üî•",
        "Parallel" => "üöÄ",
        _ => ""
    };

    private void ResetTimes()
    {
        foreach (var key in _executionTimes.Keys.ToList())
        {
            _executionTimes[key] = null;
        }
    }

    private async Task RunSequential()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();
        
        await Task.Delay(50);
        
        _executionTimes["Sequential"] = ConcurrencyService.RunSequentialDemo(message =>
        {
            _demoContainer?.Log(message);
        });

        _isBusy = false;
        StateHasChanged();
    }

    private async Task RunAsync()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();

        _executionTimes["Async"] = await ConcurrencyService.RunAsyncDemo(async message =>
        {
            _demoContainer?.Log(message);
            await InvokeAsync(StateHasChanged);
        });

        _isBusy = false;
        StateHasChanged();
    }

    private async Task RunConcurrent()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();

        _executionTimes["Concurrent"] = await ConcurrencyService.RunConcurrentDemo(async message =>
        {
            _demoContainer?.Log(message);
            await InvokeAsync(StateHasChanged);
        });

        _isBusy = false;
        StateHasChanged();
    }

    private async Task RunParallel()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();

        long elapsedMs = 0;
        await Task.Run(() =>
        {
            elapsedMs = ConcurrencyService.RunParallelDemo(message =>
            {
                InvokeAsync(() =>
                {
                    _demoContainer?.Log(message);
                    StateHasChanged();
                });
            }, _maxDegreeOfParallelism);
        });
        _executionTimes["Parallel"] = elapsedMs;

        await Task.Delay(100);
        
        _isBusy = false;
        StateHasChanged();
    }

    private void ClearLog()
    {
        _demoContainer?.Clear();
    }
}

<style>
    .bg-purple {
        background: linear-gradient(135deg, #a855f7, #9333ea) !important;
    }
    
    .table-dark {
        --bs-table-bg: transparent;
        --bs-table-border-color: var(--border-color);
    }
    
    .table-dark th {
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }
    
    .table-dark td {
        color: var(--text-primary);
    }
</style>
