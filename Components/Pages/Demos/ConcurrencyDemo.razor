@page "/demos/concurrency"
@using TechDemoDashboard.Components.Shared
@using TechDemoDashboard.Services
@inject ConcurrencyService ConcurrencyService
@rendermode InteractiveServer

<PageTitle>Concurrency Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1000px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">üßµ</span>Concurrency & Parallelism Demo
            </h1>
            <p class="text-secondary-custom">
                Explore the differences between blocking, async, and parallel execution patterns in .NET.
                Watch the log output to see how each approach behaves differently.
            </p>
        </div>

        <!-- Interview Question -->
        <div class="alert alert-info border-info mb-4">
            <div class="mb-2">
                <span class="fw-bold">üéØ Interview Question:</span> 
                <span class="fst-italic">"What's the difference between async/await, Task.WhenAll, and Parallel.ForEach?"</span>
            </div>
            <div class="ms-4">
                <strong>Answer:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>async/await:</strong> Runs tasks sequentially (one after another). Best for I/O operations.</li>
                    <li><strong>Task.WhenAll:</strong> Runs tasks concurrently (starts all at once, waits for all). Best for concurrent I/O operations.</li>
                    <li><strong>Parallel.ForEach:</strong> Uses multiple CPU threads for parallel execution. Best for CPU-intensive tasks.</li>
                </ul>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-danger" @onclick="RunSequential" disabled="@_isBusy">
                        <span class="me-1">üîÑ</span> Sequential (Blocking)
                    </button>
                    
                    <button class="btn btn-info" @onclick="RunAsync" disabled="@_isBusy">
                        <span class="me-1">‚ö°</span> Async (Sequential)
                    </button>
                    
                    <button class="btn btn-warning" @onclick="RunConcurrent" disabled="@_isBusy">
                        <span class="me-1">üî•</span> Concurrent (Task.WhenAll)
                    </button>
                    
                    <button class="btn" style="background: linear-gradient(135deg, #a855f7, #9333ea); color: white;" @onclick="RunParallel" disabled="@_isBusy">
                        <span class="me-1">üöÄ</span> Parallel (CPU)
                    </button>

                    <button class="btn btn-secondary ms-auto" @onclick="ClearLog" disabled="@_isBusy">
                        <span class="me-1">üóëÔ∏è</span> Clear Log
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-3">
                    <label for="parallelism" class="text-white fw-500 mb-0">Max Degree of Parallelism:</label>
                    <input type="range" class="form-range flex-grow-1" style="max-width: 300px;" id="parallelism" min="1" max="16" @bind="_maxDegreeOfParallelism" @bind:event="oninput" disabled="@_isBusy" />
                    <span class="badge bg-purple fs-6 px-3">@_maxDegreeOfParallelism</span>
                </div>
            </div>
        </div>

        <!-- Execution Time Comparison -->
        @if (_executionTimes.Any(kv => kv.Value.HasValue))
        {
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="h6 mb-0 fw-bold">‚è±Ô∏è Execution Time Comparison</h3>
                    <button class="btn btn-sm btn-secondary" @onclick="ResetTimes" disabled="@_isBusy">
                        üîÑ Reset
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Method</th>
                                    <th>Last Run Time</th>
                                    <th>UI Responsive</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in _executionTimes)
                                {
                                    <tr class="@(entry.Value.HasValue ? "" : "text-muted")">
                                        <td>
                                            <span class="me-2">@GetMethodIcon(entry.Key)</span>
                                            @entry.Key
                                        </td>
                                        <td class="font-monospace">
                                            @if (entry.Value.HasValue)
                                            {
                                                <span class="text-primary-custom fw-bold">@entry.Value.Value ms</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">‚Äî</span>
                                            }
                                        </td>
                                        <td>
                                            @if (entry.Key == "Sequential")
                                            {
                                                <span class="badge bg-danger">‚ùå Frozen</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">‚úÖ Yes</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- How it Works Section with Code Examples -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="h6 mb-0 fw-bold">üìñ How it Works</h3>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- Sequential Execution -->
                    <div class="col-12">
                        <div class="border-start border-danger border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-danger mb-0">1Ô∏è‚É£ Sequential - Blocking Execution</h4>
                                <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#concurrencyCode1" aria-expanded="false" aria-controls="concurrencyCode1">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                Tasks run one after another, blocking the UI thread
                            </p>
                            <div class="collapse" id="concurrencyCode1">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// ‚ùå BLOCKS UI - Don't do this!
public void ProcessDataSequential()
{
    // Task 1 - blocks for 2 seconds
    Thread.Sleep(2000);
    Console.WriteLine("Task 1 complete");
    
    // Task 2 - blocks for 2 seconds
    Thread.Sleep(2000);
    Console.WriteLine("Task 2 complete");
    
    // Task 3 - blocks for 2 seconds
    Thread.Sleep(2000);
    Console.WriteLine("Task 3 complete");
}

// Total time: 6 seconds
// UI: FROZEN during entire execution! ‚ùå</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Async Sequential -->
                    <div class="col-12">
                        <div class="border-start border-info border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-info mb-0">2Ô∏è‚É£ Async - Sequential but Non-Blocking</h4>
                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#concurrencyCode2" aria-expanded="false" aria-controls="concurrencyCode2">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                Tasks still run sequentially, but UI remains responsive
                            </p>
                            <div class="collapse" id="concurrencyCode2">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// ‚úÖ UI Responsive - Tasks run one after another
public async Task ProcessDataAsync()
{
    // Task 1 - awaits for 2 seconds (UI responsive!)
    await Task.Delay(2000);
    Console.WriteLine("Task 1 complete");
    
    // Task 2 - awaits for 2 seconds
    await Task.Delay(2000);
    Console.WriteLine("Task 2 complete");
    
    // Task 3 - awaits for 2 seconds
    await Task.Delay(2000);
    Console.WriteLine("Task 3 complete");
}

// Total time: 6 seconds (same as sequential)
// UI: Responsive! ‚úÖ
// Best for: I/O operations (database, API calls)</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Concurrent Execution -->
                    <div class="col-12">
                        <div class="border-start border-warning border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-warning mb-0">3Ô∏è‚É£ Concurrent - Task.WhenAll</h4>
                                <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#concurrencyCode3" aria-expanded="false" aria-controls="concurrencyCode3">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                All tasks start at once and run concurrently
                            </p>
                            <div class="collapse" id="concurrencyCode3">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// üî• FASTEST for I/O - All tasks run concurrently
public async Task ProcessDataConcurrent()
{
    // Start all tasks at once (don't await yet!)
    var task1 = Task.Delay(2000)
        .ContinueWith(_ => Console.WriteLine("Task 1 complete"));
    var task2 = Task.Delay(2000)
        .ContinueWith(_ => Console.WriteLine("Task 2 complete"));
    var task3 = Task.Delay(2000)
        .ContinueWith(_ => Console.WriteLine("Task 3 complete"));
    
    // Wait for ALL to complete
    await Task.WhenAll(task1, task2, task3);
}

// Total time: 2 seconds (all run at same time!)
// UI: Responsive! ‚úÖ
// Best for: Multiple independent I/O operations</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Parallel Execution -->
                    <div class="col-12">
                        <div class="border-start border-3 ps-3" style="border-color: #a855f7;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold mb-0" style="color: #a855f7;">4Ô∏è‚É£ Parallel - CPU-Bound Processing</h4>
                                <button class="btn btn-sm btn-outline" style="color: #a855f7; border-color: #a855f7;" type="button" data-bs-toggle="collapse" data-bs-target="#concurrencyCode4" aria-expanded="false" aria-controls="concurrencyCode4">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                Uses multiple CPU threads for parallel processing
                            </p>
                            <div class="collapse" id="concurrencyCode4">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// üöÄ FASTEST for CPU work - Uses multiple threads
public void ProcessDataParallel()
{
    var items = Enumerable.Range(1, 100).ToList();
    
    // Process items in parallel across multiple CPU cores
    Parallel.ForEach(items, 
        new ParallelOptions 
        { 
            MaxDegreeOfParallelism = 4  // Use 4 threads
        },
        item =>
        {
            // CPU-intensive work
            var result = ComplexCalculation(item);
            Console.WriteLine($"Processed {item}: {result}");
        });
}

// Uses: Multiple CPU threads
// Best for: CPU-intensive calculations, image processing
// Note: Doesn't help with I/O-bound operations!</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3 mb-0">
                    <strong>üí° Key Takeaway:</strong> Use <strong>async/await</strong> for I/O operations, <strong>Task.WhenAll</strong> for concurrent I/O, and <strong>Parallel.ForEach</strong> for CPU-intensive work!
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private DemoContainer? _demoContainer;
    private bool _isBusy;
    private int _maxDegreeOfParallelism = 4;
    
    private Dictionary<string, long?> _executionTimes = new()
    {
        ["Sequential"] = null,
        ["Async"] = null,
        ["Concurrent"] = null,
        ["Parallel"] = null
    };

    private string GetMethodIcon(string method) => method switch
    {
        "Sequential" => "üîÑ",
        "Async" => "‚ö°",
        "Concurrent" => "üî•",
        "Parallel" => "üöÄ",
        _ => ""
    };

    private void ResetTimes()
    {
        foreach (var key in _executionTimes.Keys.ToList())
        {
            _executionTimes[key] = null;
        }
    }

    private async Task RunSequential()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();
        
        await Task.Delay(50);
        
        _executionTimes["Sequential"] = ConcurrencyService.RunSequentialDemo(message =>
        {
            _demoContainer?.Log(message);
        });

        _isBusy = false;
        StateHasChanged();
    }

    private async Task RunAsync()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();

        _executionTimes["Async"] = await ConcurrencyService.RunAsyncDemo(async message =>
        {
            _demoContainer?.Log(message);
            await InvokeAsync(StateHasChanged);
        });

        _isBusy = false;
        StateHasChanged();
    }

    private async Task RunConcurrent()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();

        _executionTimes["Concurrent"] = await ConcurrencyService.RunConcurrentDemo(async message =>
        {
            _demoContainer?.Log(message);
            await InvokeAsync(StateHasChanged);
        });

        _isBusy = false;
        StateHasChanged();
    }

    private async Task RunParallel()
    {
        _isBusy = true;
        _demoContainer?.Clear();
        StateHasChanged();

        long elapsedMs = 0;
        await Task.Run(() =>
        {
            elapsedMs = ConcurrencyService.RunParallelDemo(message =>
            {
                InvokeAsync(() =>
                {
                    _demoContainer?.Log(message);
                    StateHasChanged();
                });
            }, _maxDegreeOfParallelism);
        });
        _executionTimes["Parallel"] = elapsedMs;

        await Task.Delay(100);
        
        _isBusy = false;
        StateHasChanged();
    }

    private void ClearLog()
    {
        _demoContainer?.Clear();
    }
}

<style>
    .bg-purple {
        background: linear-gradient(135deg, #a855f7, #9333ea) !important;
    }
    
    .table-dark {
        --bs-table-bg: transparent;
        --bs-table-border-color: var(--border-color);
    }
    
    .table-dark th {
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }
    
    .table-dark td {
        color: var(--text-primary);
    }
</style>
