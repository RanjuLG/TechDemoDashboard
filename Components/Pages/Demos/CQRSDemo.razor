@page "/demos/cqrs"
@using TechDemoDashboard.Services
@using TechDemoDashboard.Models
@rendermode InteractiveServer

<PageTitle>CQRS Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1400px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">üîÄ</span>CQRS - Command Query Responsibility Segregation
            </h1>
            <p class="text-secondary-custom">
                Separate <strong class="text-white">write operations</strong> (Commands) from <strong class="text-white">read operations</strong> (Queries). 
                Watch how changes in the write model project to the read model through events!
            </p>
        </div>

        <!-- Interview Question -->
        <div class="alert alert-info border-info mb-4">
            <div class="mb-2">
                <span class="fw-bold">üéØ Interview Question:</span> 
                <span class="fst-italic">"What is CQRS and when would you use it?"</span>
            </div>
            <div class="ms-4">
                <strong>Answer:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>CQRS:</strong> A pattern that separates read and write operations into different models. Commands modify data; Queries retrieve data.</li>
                    <li><strong>Benefits:</strong> Independent scaling of reads/writes, optimized data models for each operation, better performance, and clearer separation of concerns.</li>
                    <li><strong>When to use:</strong> Complex domains with different read/write patterns, high-traffic systems needing independent scaling, or when combined with Event Sourcing.</li>
                    <li><strong>Trade-offs:</strong> Increased complexity, eventual consistency between models, and requires careful design.</li>
                </ul>
            </div>
        </div>

        <!-- Architecture Summary -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold text-white me-3">üìä Architecture Status:</span>
                        <span class="text-secondary-custom">@Service.GetArchitectureSummary()</span>
                    </div>
                    <button class="btn btn-sm btn-secondary" @onclick="Service.ClearActivityLog">Clear Log</button>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Left Column: Commands -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="h5 mb-0 fw-bold">üìù Commands (Write Operations)</h2>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-secondary-custom small mb-4">Commands modify the write model and publish events</p>

                        <!-- Create Product -->
                        <div class="mb-4 p-3 border border-success rounded">
                            <h3 class="h6 fw-bold text-success mb-3">‚ûï Create Product</h3>
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                       placeholder="Product Name" @bind="newProductName" />
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <input type="number" step="0.01" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                           placeholder="Price" @bind="newProductPrice" />
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                           placeholder="Stock" @bind="newProductStock" />
                                </div>
                            </div>
                            <button class="btn btn-success btn-sm w-100" @onclick="CreateProduct">Create Product</button>
                        </div>

                        <!-- Update Price -->
                        <div class="mb-4 p-3 border border-warning rounded">
                            <h3 class="h6 fw-bold text-warning mb-3">üí∞ Update Price</h3>
                            <div class="mb-2">
                                <select class="form-select form-select-sm bg-dark text-white border-secondary" @bind="selectedProductId">
                                    <option value="">Select Product...</option>
                                    @foreach (var product in Service.GetAllProductsFromWriteStore())
                                    {
                                        <option value="@product.Id">@product.Name (Current: $@product.Price.ToString("F2"))</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="number" step="0.01" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                       placeholder="New Price" @bind="updatePrice" />
                            </div>
                            <button class="btn btn-warning btn-sm w-100" @onclick="UpdateProductPrice">Update Price</button>
                        </div>

                        <!-- Update Stock -->
                        <div class="mb-4 p-3 border border-info rounded">
                            <h3 class="h6 fw-bold text-info mb-3">üì¶ Update Stock</h3>
                            <div class="mb-2">
                                <select class="form-select form-select-sm bg-dark text-white border-secondary" @bind="selectedProductId">
                                    <option value="">Select Product...</option>
                                    @foreach (var product in Service.GetAllProductsFromWriteStore())
                                    {
                                        <option value="@product.Id">@product.Name (Current: @product.Stock units)</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                       placeholder="New Stock" @bind="updateStock" />
                            </div>
                            <button class="btn btn-info btn-sm w-100" @onclick="UpdateProductStock">Update Stock</button>
                        </div>

                        <!-- Delete Product -->
                        <div class="p-3 border border-danger rounded">
                            <h3 class="h6 fw-bold text-danger mb-3">üóëÔ∏è Delete Product</h3>
                            <div class="mb-2">
                                <select class="form-select form-select-sm bg-dark text-white border-secondary" @bind="selectedProductId">
                                    <option value="">Select Product...</option>
                                    @foreach (var product in Service.GetAllProductsFromWriteStore())
                                    {
                                        <option value="@product.Id">@product.Name</option>
                                    }
                                </select>
                            </div>
                            <button class="btn btn-danger btn-sm w-100" @onclick="DeleteProduct">Delete Product</button>
                        </div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="h5 mb-0 fw-bold">üìã Activity Log</h2>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-3 bg-dark rounded" style="max-height: 400px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85rem;">
                            @if (!Service.ActivityLog.Any())
                            {
                                <div class="text-center text-muted py-4">
                                    Execute commands and queries to see activity!
                                </div>
                            }
                            else
                            {
                                @foreach (var entry in Service.ActivityLog.TakeLast(30).Reverse())
                                {
                                    <div class="text-secondary-custom py-1 border-bottom border-secondary">@entry</div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Queries and Results -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="h5 mb-0 fw-bold">üîç Queries (Read Operations)</h2>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-secondary-custom small mb-4">Queries read from the optimized read model</p>

                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" @onclick="GetAllProducts">
                                üìã Get All Products
                            </button>

                            <button class="btn btn-outline-warning" @onclick="GetLowStockProducts">
                                ‚ö†Ô∏è Get Low Stock Products ( &lt;10)
                            </button>

                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control bg-dark text-white border-secondary" 
                                       placeholder="Min Price" @bind="minPrice" />
                                <input type="number" step="0.01" class="form-control bg-dark text-white border-secondary" 
                                       placeholder="Max Price" @bind="maxPrice" />
                                <button class="btn btn-outline-success" @onclick="GetProductsByPriceRange">
                                    üí≤ Filter by Price
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Query Results -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="h5 mb-0 fw-bold">üìä Query Results</h2>
                    </div>
                    <div class="card-body p-3">
                        @if (!string.IsNullOrEmpty(Service.LastQueryDescription))
                        {
                            <div class="alert alert-info mb-3">
                                <small>@Service.LastQueryDescription</small>
                            </div>
                        }

                        @if (!Service.QueryResults.Any())
                        {
                            <div class="text-center text-muted py-4">
                                Execute a query to see results from the read model
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th>Events</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in Service.QueryResults)
                                        {
                                            <tr>
                                                <td class="fw-bold">@product.Name</td>
                                                <td>$@product.Price.ToString("F2")</td>
                                                <td>@product.Stock</td>
                                                <td>
                                                    <span class="badge @GetStockBadgeClass(product.Stock)">
                                                        @product.StockStatus
                                                    </span>
                                                </td>
                                                <td><span class="badge bg-info">@product.TotalEvents</span></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- How it Works Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="h6 mb-0 fw-bold">üìñ How it Works</h3>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- Commands -->
                    <div class="col-md-6">
                        <div class="border-start border-success border-3 ps-3">
                            <h4 class="h6 fw-bold text-success mb-2">1Ô∏è‚É£ Commands - Write Operations</h4>
                            <p class="small text-secondary-custom mb-2">
                                Commands represent intentions to change state
                            </p>
                            <ul class="small mb-0">
                                <li>Modify the write model (domain entities)</li>
                                <li>Contain business logic and validation</li>
                                <li>Publish domain events after successful execution</li>
                                <li>Examples: CreateProduct, UpdatePrice, DeleteProduct</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Queries -->
                    <div class="col-md-6">
                        <div class="border-start border-info border-3 ps-3">
                            <h4 class="h6 fw-bold text-info mb-2">2Ô∏è‚É£ Queries - Read Operations</h4>
                            <p class="small text-secondary-custom mb-2">
                                Queries retrieve data without modifying state
                            </p>
                            <ul class="small mb-0">
                                <li>Read from optimized read models</li>
                                <li>Never modify data (no side effects)</li>
                                <li>Can use denormalized data for fast reads</li>
                                <li>Examples: GetAllProducts, GetLowStockProducts</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Write Model -->
                    <div class="col-md-6">
                        <div class="border-start border-warning border-3 ps-3">
                            <h4 class="h6 fw-bold text-warning mb-2">3Ô∏è‚É£ Write Model (Domain)</h4>
                            <p class="small text-secondary-custom mb-2">
                                Optimized for write operations and business logic
                            </p>
                            <ul class="small mb-0">
                                <li>Contains domain entities (Product class)</li>
                                <li>Enforces business rules and constraints</li>
                                <li>Normalized data structure</li>
                                <li>Source of truth for state changes</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Read Model -->
                    <div class="col-md-6">
                        <div class="border-start border-primary border-3 ps-3">
                            <h4 class="h6 fw-bold text-primary-custom mb-2">4Ô∏è‚É£ Read Model (Projections)</h4>
                            <p class="small text-secondary-custom mb-2">
                                Optimized for query performance
                            </p>
                            <ul class="small mb-0">
                                <li>Denormalized for fast queries (ProductReadModel)</li>
                                <li>Contains computed fields (StockStatus)</li>
                                <li>Aggregated data (TotalEvents count)</li>
                                <li>Updated via projections from write model</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Event Sourcing -->
                    <div class="col-12">
                        <div class="border-start border-danger border-3 ps-3">
                            <h4 class="h6 fw-bold text-danger mb-2">5Ô∏è‚É£ Event Sourcing - Complete Audit Trail</h4>
                            <p class="small text-secondary-custom mb-2">
                                Every state change is captured as an immutable event
                            </p>
                            <ul class="small mb-0">
                                <li><strong>ProductCreatedEvent:</strong> Captures when a product is added</li>
                                <li><strong>ProductPriceChangedEvent:</strong> Records price modifications</li>
                                <li><strong>ProductStockChangedEvent:</strong> Tracks inventory updates</li>
                                <li><strong>ProductDeletedEvent:</strong> Logs product removals</li>
                                <li>Events can rebuild state, provide audit trail, and enable time travel debugging</li>
                            </ul>
                        </div>
                    </div>

                    <!-- The Flow -->
                    <div class="col-12">
                        <div class="alert alert-success">
                            <h4 class="h6 fw-bold mb-2">üîÑ The Complete Flow</h4>
                            <ol class="mb-0 small">
                                <li><strong>Command Received:</strong> User executes CreateProduct command</li>
                                <li><strong>Write Model Updated:</strong> Product entity created and stored in write database</li>
                                <li><strong>Event Published:</strong> ProductCreatedEvent added to event store</li>
                                <li><strong>Read Model Projected:</strong> ProductReadModel created from Product entity</li>
                                <li><strong>Query Executed:</strong> User runs GetAllProducts query</li>
                                <li><strong>Data Retrieved:</strong> Results returned from read model (not write model!)</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3 mb-0">
                    <strong>üí° Key Benefits:</strong> Write and read models can be scaled independently, optimized separately, and even use different databases (SQL for writes, NoSQL for reads). Perfect for high-traffic systems with complex read patterns!
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject]
    private CQRSService Service { get; set; } = default!;

    // Command inputs
    private string newProductName = "";
    private decimal newProductPrice = 0;
    private int newProductStock = 0;
    private string selectedProductId = "";
    private decimal updatePrice = 0;
    private int updateStock = 0;

    // Query inputs
    private decimal minPrice = 0;
    private decimal maxPrice = 1000;

    // Command methods
    private void CreateProduct()
    {
        if (!string.IsNullOrWhiteSpace(newProductName) && newProductPrice > 0)
        {
            Service.HandleCreateProduct(new CreateProductCommand(newProductName, newProductPrice, newProductStock));
            newProductName = "";
            newProductPrice = 0;
            newProductStock = 0;
        }
    }

    private void UpdateProductPrice()
    {
        if (Guid.TryParse(selectedProductId, out var productId) && updatePrice > 0)
        {
            Service.HandleUpdatePrice(new UpdateProductPriceCommand(productId, updatePrice));
            updatePrice = 0;
        }
    }

    private void UpdateProductStock()
    {
        if (Guid.TryParse(selectedProductId, out var productId))
        {
            Service.HandleUpdateStock(new UpdateProductStockCommand(productId, updateStock));
            updateStock = 0;
        }
    }

    private void DeleteProduct()
    {
        if (Guid.TryParse(selectedProductId, out var productId))
        {
            Service.HandleDeleteProduct(new DeleteProductCommand(productId));
            selectedProductId = "";
        }
    }

    // Query methods
    private void GetAllProducts()
    {
        Service.HandleGetAllProducts(new GetAllProductsQuery());
    }

    private void GetLowStockProducts()
    {
        Service.HandleGetLowStockProducts(new GetLowStockProductsQuery());
    }

    private void GetProductsByPriceRange()
    {
        Service.HandleGetProductsByPriceRange(new GetProductsByPriceRangeQuery(minPrice, maxPrice));
    }

    // Helper methods
    private string GetStockBadgeClass(int stock)
    {
        return stock switch
        {
            0 => "bg-danger",
            < 10 => "bg-warning",
            < 50 => "bg-info",
            _ => "bg-success"
        };
    }
}
