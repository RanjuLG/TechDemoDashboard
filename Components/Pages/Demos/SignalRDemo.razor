@page "/demos/signalr"
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>SignalR Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1000px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">üì°</span>SignalR Real-time Demo
            </h1>
            <p class="text-secondary-custom">
                Experience real-time communication with SignalR. Open this page in multiple browser tabs
                to see messages appear instantly across all connected clients.
            </p>
        </div>

        <!-- Interview Question -->
        <div class="alert alert-info border-info mb-4">
            <div class="mb-2">
                <span class="fw-bold">üéØ Interview Question:</span> 
                <span class="fst-italic">"What's the difference between SignalR, WebSockets, and HTTP polling?"</span>
            </div>
            <div class="ms-4">
                <strong>Answer:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>WebSockets:</strong> Low-level protocol for bidirectional, full-duplex communication over a single TCP connection.</li>
                    <li><strong>SignalR:</strong> High-level library that uses WebSockets when available, but falls back to Server-Sent Events or Long Polling. Provides automatic reconnection, hub abstraction, and connection management.</li>
                    <li><strong>HTTP Polling:</strong> Client repeatedly requests updates from server. Simple but inefficient (high latency, server load).</li>
                </ul>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="mb-4">
            <div class="alert @(_isConnected ? "alert-success" : "alert-danger") d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <span class="fs-5">@(_isConnected ? "üü¢" : "üî¥")</span>
                    <span class="fw-bold">@(_isConnected ? "Connected" : "Disconnected")</span>
                </div>
                @if (!_isConnected)
                {
                    <button class="btn btn-sm btn-outline-light" @onclick="Connect" disabled="@_isConnecting">
                        @(_isConnecting ? "Connecting..." : "Reconnect")
                    </button>
                }
            </div>
        </div>

        <!-- User Input -->
        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="username" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="username" @bind="_userName" 
                               placeholder="Enter your name..." disabled="@(!_isConnected)" />
                    </div>
                    <div class="col-md-8">
                        <label for="message" class="form-label">Message</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="message" @bind="_messageInput" 
                                   @onkeypress="HandleKeyPress" placeholder="Type a message..."
                                   disabled="@(!_isConnected || string.IsNullOrWhiteSpace(_userName))" />
                            <button class="btn btn-primary" @onclick="SendMessage" 
                                    disabled="@(!_isConnected || string.IsNullOrWhiteSpace(_userName) || string.IsNullOrWhiteSpace(_messageInput))">
                                Send üì§
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="h6 mb-0 fw-bold">üí¨ Messages</h3>
                <span class="badge bg-secondary">@_messages.Count messages</span>
            </div>
            <div class="card-body p-0">
                <div class="p-3" style="max-height: 400px; overflow-y: auto;">
                    @if (_messages.Count == 0)
                    {
                        <div class="text-center text-muted py-5">
                            <div class="fs-1 mb-2">üì≠</div>
                            <p class="mb-0">No messages yet. Be the first to send one!</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var msg in _messages.AsEnumerable().Reverse())
                        {
                            <div class="mb-3 p-3 rounded @(msg.User == _userName ? "bg-success bg-opacity-10 border-start border-success border-3" : "bg-secondary bg-opacity-10")">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold @(msg.User == _userName ? "text-primary-custom" : "text-info")">@msg.User</span>
                                    <span class="small text-muted font-monospace">@msg.Timestamp.ToString("HH:mm:ss")</span>
                                </div>
                                <div class="text-white-50">@msg.Content</div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- How it Works Section with Code Examples -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="h6 mb-0 fw-bold">üìñ How it Works</h3>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- WebSocket Connection -->
                    <div class="col-12">
                        <div class="border-start border-info border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-info mb-0">1Ô∏è‚É£ WebSocket Connection</h4>
                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#code1" aria-expanded="false" aria-controls="code1">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                SignalR establishes a persistent connection for instant communication
                            </p>
                            <div class="collapse" id="code1">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// Client-side: Establish connection
_hubConnection = new HubConnectionBuilder()
    .WithUrl("/chathub")           // Connect to hub endpoint
    .WithAutomaticReconnect()      // Auto-reconnect if disconnected
    .Build();

await _hubConnection.StartAsync(); // Open WebSocket connection</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hub Pattern -->
                    <div class="col-12">
                        <div class="border-start border-warning border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-warning mb-0">2Ô∏è‚É£ Hub Pattern (Server-Side)</h4>
                                <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#code2" aria-expanded="false" aria-controls="code2">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                The server-side ChatHub broadcasts messages to all connected clients
                            </p>
                            <div class="collapse" id="code2">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// Server-side Hub (ChatHub.cs)
public class ChatHub : Hub
{
    public async Task SendMessage(string user, string message)
    {
        // Broadcast to ALL connected clients
        await Clients.All.SendAsync(
            "ReceiveMessage",      // Method name
            user,                  // Parameters
            message,
            DateTime.Now
        );
    }
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Real-time Updates -->
                    <div class="col-12">
                        <div class="border-start border-success border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-success mb-0">3Ô∏è‚É£ Real-time Updates (Client Receives)</h4>
                                <button class="btn btn-sm btn-outline-success" type="button" data-bs-toggle="collapse" data-bs-target="#code3" aria-expanded="false" aria-controls="code3">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                No page refresh needed - messages appear instantly when received
                            </p>
                            <div class="collapse" id="code3">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// Client-side: Listen for messages from server
_hubConnection.On&lt;string, string, DateTime&gt;(
    "ReceiveMessage",              // Listen for this method
    (user, message, timestamp) =>  // Callback when received
    {
        _messages.Add(new ChatMessage(user, message, timestamp));
        InvokeAsync(StateHasChanged); // Update UI instantly!
    }
);</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Send Message -->
                    <div class="col-12">
                        <div class="border-start border-primary border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-primary-custom mb-0">4Ô∏è‚É£ Sending Messages</h4>
                                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#code4" aria-expanded="false" aria-controls="code4">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                Client sends message to server, which broadcasts to all clients
                            </p>
                            <div class="collapse" id="code4">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// Client-side: Send message to server
await _hubConnection.SendAsync(
    "SendMessage",    // Call server hub method
    _userName,        // Parameters
    _messageInput
);

// Server receives ‚Üí Broadcasts to ALL ‚Üí All clients receive instantly!</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3 mb-0">
                    <strong>üí° Tip:</strong> Open this page in another tab or browser to see real-time sync in action!
                    Messages sent from one tab appear instantly in all other tabs.
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private HubConnection? _hubConnection;
    private string _userName = "";
    private string _messageInput = "";
    private bool _isConnected => _hubConnection?.State == HubConnectionState.Connected;
    private bool _isConnecting;
    private List<ChatMessage> _messages = new();

    protected override async Task OnInitializedAsync()
    {
        await Connect();
    }

    private async Task Connect()
    {
        if (_isConnecting) return;
        
        _isConnecting = true;
        StateHasChanged();

        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
                .WithAutomaticReconnect()
                .Build();

            _hubConnection.On<string, string, DateTime>("ReceiveMessage", (user, message, timestamp) =>
            {
                _messages.Add(new ChatMessage(user, message, timestamp));
                InvokeAsync(StateHasChanged);
            });

            _hubConnection.On<string>("UserConnected", (connectionId) =>
            {
                _messages.Add(new ChatMessage("System", $"A new user connected", DateTime.Now));
                InvokeAsync(StateHasChanged);
            });

            _hubConnection.On<string>("UserDisconnected", (connectionId) =>
            {
                _messages.Add(new ChatMessage("System", $"A user disconnected", DateTime.Now));
                InvokeAsync(StateHasChanged);
            });

            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatMessage("System", $"Connection failed: {ex.Message}", DateTime.Now));
        }
        finally
        {
            _isConnecting = false;
            StateHasChanged();
        }
    }

    private async Task SendMessage()
    {
        if (_hubConnection is not null && !string.IsNullOrWhiteSpace(_messageInput))
        {
            await _hubConnection.SendAsync("SendMessage", _userName, _messageInput);
            _messageInput = "";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private record ChatMessage(string User, string Content, DateTime Timestamp);

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;
}

