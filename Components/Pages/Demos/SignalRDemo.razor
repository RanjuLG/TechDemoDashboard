@page "/demos/signalr"
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>SignalR Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1000px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">ðŸ“¡</span>SignalR Real-time Demo
            </h1>
            <p class="text-secondary-custom">
                Experience real-time communication with SignalR. Open this page in multiple browser tabs
                to see messages appear instantly across all connected clients.
            </p>
        </div>

        <!-- Connection Status -->
        <div class="mb-4">
            <div class="alert @(_isConnected ? "alert-success" : "alert-danger") d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <span class="fs-5">@(_isConnected ? "ðŸŸ¢" : "ðŸ”´")</span>
                    <span class="fw-bold">@(_isConnected ? "Connected" : "Disconnected")</span>
                </div>
                @if (!_isConnected)
                {
                    <button class="btn btn-sm btn-outline-light" @onclick="Connect" disabled="@_isConnecting">
                        @(_isConnecting ? "Connecting..." : "Reconnect")
                    </button>
                }
            </div>
        </div>

        <!-- User Input -->
        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="username" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="username" @bind="_userName" 
                               placeholder="Enter your name..." disabled="@(!_isConnected)" />
                    </div>
                    <div class="col-md-8">
                        <label for="message" class="form-label">Message</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="message" @bind="_messageInput" 
                                   @onkeypress="HandleKeyPress" placeholder="Type a message..."
                                   disabled="@(!_isConnected || string.IsNullOrWhiteSpace(_userName))" />
                            <button class="btn btn-primary" @onclick="SendMessage" 
                                    disabled="@(!_isConnected || string.IsNullOrWhiteSpace(_userName) || string.IsNullOrWhiteSpace(_messageInput))">
                                Send ðŸ“¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="h6 mb-0 fw-bold">ðŸ’¬ Messages</h3>
                <span class="badge bg-secondary">@_messages.Count messages</span>
            </div>
            <div class="card-body p-0">
                <div class="p-3" style="max-height: 400px; overflow-y: auto;">
                    @if (_messages.Count == 0)
                    {
                        <div class="text-center text-muted py-5">
                            <div class="fs-1 mb-2">ðŸ“­</div>
                            <p class="mb-0">No messages yet. Be the first to send one!</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var msg in _messages.AsEnumerable().Reverse())
                        {
                            <div class="mb-3 p-3 rounded @(msg.User == _userName ? "bg-success bg-opacity-10 border-start border-success border-3" : "bg-secondary bg-opacity-10")">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold @(msg.User == _userName ? "text-primary-custom" : "text-info")">@msg.User</span>
                                    <span class="small text-muted font-monospace">@msg.Timestamp.ToString("HH:mm:ss")</span>
                                </div>
                                <div class="text-white-50">@msg.Content</div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="alert alert-info">
            <h3 class="h6 fw-bold mb-2">ðŸ“– How it works</h3>
            <ul class="mb-2 small">
                <li><strong>WebSocket Connection:</strong> SignalR establishes a persistent connection for instant communication</li>
                <li><strong>Hub Pattern:</strong> The server-side ChatHub broadcasts messages to all connected clients</li>
                <li><strong>Real-time Updates:</strong> No page refresh needed - messages appear instantly</li>
            </ul>
            <p class="mb-0 small"><strong>ðŸ’¡ Tip:</strong> Open this page in another tab or browser to see real-time sync in action!</p>
        </div>
    </div>
</div>

@code {
    private HubConnection? _hubConnection;
    private string _userName = "";
    private string _messageInput = "";
    private bool _isConnected => _hubConnection?.State == HubConnectionState.Connected;
    private bool _isConnecting;
    private List<ChatMessage> _messages = new();

    protected override async Task OnInitializedAsync()
    {
        await Connect();
    }

    private async Task Connect()
    {
        if (_isConnecting) return;
        
        _isConnecting = true;
        StateHasChanged();

        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
                .WithAutomaticReconnect()
                .Build();

            _hubConnection.On<string, string, DateTime>("ReceiveMessage", (user, message, timestamp) =>
            {
                _messages.Add(new ChatMessage(user, message, timestamp));
                InvokeAsync(StateHasChanged);
            });

            _hubConnection.On<string>("UserConnected", (connectionId) =>
            {
                _messages.Add(new ChatMessage("System", $"A new user connected", DateTime.Now));
                InvokeAsync(StateHasChanged);
            });

            _hubConnection.On<string>("UserDisconnected", (connectionId) =>
            {
                _messages.Add(new ChatMessage("System", $"A user disconnected", DateTime.Now));
                InvokeAsync(StateHasChanged);
            });

            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatMessage("System", $"Connection failed: {ex.Message}", DateTime.Now));
        }
        finally
        {
            _isConnecting = false;
            StateHasChanged();
        }
    }

    private async Task SendMessage()
    {
        if (_hubConnection is not null && !string.IsNullOrWhiteSpace(_messageInput))
        {
            await _hubConnection.SendAsync("SendMessage", _userName, _messageInput);
            _messageInput = "";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private record ChatMessage(string User, string Content, DateTime Timestamp);

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;
}
