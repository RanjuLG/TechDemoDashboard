@page "/demos/race-condition"
@using TechDemoDashboard.Services
@inject TicketService TicketService
@rendermode InteractiveServer

<PageTitle>Race Condition Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1200px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">üîí</span>Race Condition & Locking Demo
            </h1>
            <p class="text-secondary-custom">
                Visualize what happens when multiple threads try to access shared resources simultaneously.
                This demonstrates the classic "double-booking" or "overselling" problem.
            </p>
        </div>

        <!-- Interview Question -->
        <div class="alert alert-info border-info mb-4">
            <div class="mb-2">
                <span class="fw-bold">üéØ Interview Question:</span>
                <span class="fst-italic">"Two users try to buy the last ticket at the exact same millisecond. How do you prevent selling it twice?"</span>
            </div>
            <div class="ms-4">
                <strong>Answer:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>Problem:</strong> Race condition occurs when multiple threads access shared data simultaneously without synchronization.</li>
                    <li><strong>Solution:</strong> Use the <code>lock</code> statement to ensure only one thread can access the critical section at a time.</li>
                    <li><strong>How it works:</strong> The lock creates a mutual exclusion (mutex) - when one thread enters the locked section, other threads must wait until it's released.</li>
                    <li><strong>Best Practice:</strong> Always lock on a private readonly object, keep the locked section as small as possible for better performance.</li>
                </ul>
            </div>
        </div>

        <!-- Scenario Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="h6 mb-0 fw-bold">üìã Scenario</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="small text-muted mb-1">Available Tickets</div>
                            <div class="h4 fw-bold text-info mb-0">1</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="small text-muted mb-1">Concurrent Buyers</div>
                            <div class="h4 fw-bold text-info mb-0">@_buyerCount</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="small text-muted mb-1">Each Buyer</div>
                            <div class="small text-info mb-0">Read ‚Üí Check ‚Üí Wait 10ms ‚Üí Decrement</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <label for="buyers" class="form-label mb-1">Number of Buyers: <span class="text-primary-custom fw-bold">@_buyerCount</span></label>
                        <input type="range" class="form-range" id="buyers" min="5" max="20" @bind="_buyerCount" @bind:event="oninput" disabled="@_isRunning" />
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex gap-2">
                            <button class="btn btn-danger" @onclick="RunWithoutLock" disabled="@_isRunning">
                                ‚ùå Run WITHOUT Lock
                            </button>
                            <button class="btn btn-success" @onclick="RunWithLock" disabled="@_isRunning">
                                ‚úÖ Run WITH Lock
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        @if (_hasResult)
        {
            <div class="card mb-4 border-@(_lastUsedLock ? "success" : (_lastFinalTickets < 0 ? "danger" : "warning"))">
                <div class="card-header bg-@(_lastUsedLock ? "success" : (_lastFinalTickets < 0 ? "danger" : "warning")) bg-opacity-10">
                    <h3 class="h6 mb-0 fw-bold">üìä Results</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4 text-center">
                            <div class="small text-muted mb-1">Successful Purchases</div>
                            <div class="h3 fw-bold text-success mb-0">@_lastSuccessCount</div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="small text-muted mb-1">Failed Purchases</div>
                            <div class="h3 fw-bold text-secondary mb-0">@_lastFailCount</div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="small text-muted mb-1">Final Ticket Count</div>
                            <div class="h3 fw-bold @(_lastFinalTickets < 0 ? "text-danger" : "text-success") mb-0">@_lastFinalTickets</div>
                        </div>
                    </div>

                    @if (!_lastUsedLock && _lastFinalTickets < 0)
                    {
                        <div class="alert alert-danger mb-0">
                            <strong>‚ö†Ô∏è OVERSOLD by @(Math.Abs(_lastFinalTickets)) tickets!</strong><br/>
                            This is the race condition bug. Multiple threads read the same value before any decremented.
                        </div>
                    }
                    else if (_lastUsedLock && _lastFinalTickets == 0 && _lastSuccessCount == 1)
                    {
                        <div class="alert alert-success mb-0">
                            <strong>‚ú® Perfect!</strong> The lock prevented overselling. Only 1 buyer succeeded, exactly as expected.
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Execution Log -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="h6 mb-0 fw-bold">üìú Execution Log</h3>
                <button class="btn btn-sm btn-secondary" @onclick="ClearLog">Clear</button>
            </div>
            <div class="card-body p-0">
                <div class="p-3 bg-dark font-monospace small" style="max-height: 300px; overflow-y: auto;">
                    @if (TicketService.Log.Count == 0)
                    {
                        <p class="text-muted text-center mb-0">Run a simulation to see the execution log...</p>
                    }
                    else
                    {
                        @foreach (var entry in TicketService.Log)
                        {
                            <div class="@GetLogEntryClass(entry) py-1">@entry</div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Code Comparison -->
        <div class="card">
            <div class="card-header">
                <h3 class="h6 mb-0 fw-bold">üìñ The Fix: Using Locks</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="border border-danger rounded p-3 bg-danger bg-opacity-10">
                            <h4 class="h6 text-danger mb-2">‚ùå Unsafe (Race Condition)</h4>
                            <pre class="mb-0"><code class="text-white-50">if (tickets > 0)
{
    Thread.Sleep(10); // Latency
    tickets--;        // BUG: Others may have decremented!
}</code></pre>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border border-success rounded p-3 bg-success bg-opacity-10">
                            <h4 class="h6 text-success mb-2">‚úÖ Safe (With Lock)</h4>
                            <pre class="mb-0"><code class="text-white-50">lock (_lockObject)
{
    if (tickets > 0)
    {
        Thread.Sleep(10);
        tickets--;    // Only one thread at a time
    }
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int _buyerCount = 10;
    private bool _isRunning;
    private bool _hasResult;
    private int _lastSuccessCount;
    private int _lastFailCount;
    private int _lastFinalTickets;
    private bool _lastUsedLock;

    private async Task RunWithoutLock()
    {
        await RunSimulation(useLocking: false);
    }

    private async Task RunWithLock()
    {
        await RunSimulation(useLocking: true);
    }

    private async Task RunSimulation(bool useLocking)
    {
        _isRunning = true;
        StateHasChanged();

        await Task.Delay(50);

        await Task.Run(() =>
        {
            var (success, fail, final) = TicketService.SimulateConcurrentPurchases(_buyerCount, useLocking);
            _lastSuccessCount = success;
            _lastFailCount = fail;
            _lastFinalTickets = final;
            _lastUsedLock = useLocking;
            _hasResult = true;
        });

        _isRunning = false;
        StateHasChanged();
    }

    private void ClearLog()
    {
        TicketService.Reset(1);
        _hasResult = false;
        StateHasChanged();
    }

    private string GetLogEntryClass(string entry)
    {
        if (entry.Contains("‚úÖ")) return "text-success";
        if (entry.Contains("‚ùå")) return "text-danger";
        if (entry.Contains("‚ö†Ô∏è")) return "text-warning";
        if (entry.Contains("üîí")) return "text-info";
        return "text-secondary";
    }
}
