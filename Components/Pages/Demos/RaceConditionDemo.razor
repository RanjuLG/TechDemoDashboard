@page "/demos/race-condition"
@using TechDemoDashboard.Services
@inject TicketService TicketService
@rendermode InteractiveServer

<PageTitle>Race Condition Demo</PageTitle>

<div class="min-vh-100 bg-dark-custom p-4">
    <div class="container-fluid" style="max-width: 1200px;">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-primary-custom mb-2">
                <span class="me-2">üîí</span>Race Condition & Locking Demo
            </h1>
            <p class="text-secondary-custom">
                Visualize what happens when multiple threads try to access shared resources simultaneously.
                This demonstrates the classic "double-booking" or "overselling" problem.
            </p>
        </div>

        <!-- Interview Question -->
        <div class="alert alert-info border-info mb-4">
            <div class="mb-2">
                <span class="fw-bold">üéØ Interview Question:</span>
                <span class="fst-italic">"Two users try to buy the last ticket at the exact same millisecond. How do you prevent selling it twice?"</span>
            </div>
            <div class="ms-4">
                <strong>Answer:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>Problem:</strong> Race condition occurs when multiple threads access shared data simultaneously without synchronization.</li>
                    <li><strong>Solution:</strong> Use the <code>lock</code> statement to ensure only one thread can access the critical section at a time.</li>
                    <li><strong>How it works:</strong> The lock creates a mutual exclusion (mutex) - when one thread enters the locked section, other threads must wait until it's released.</li>
                    <li><strong>Best Practice:</strong> Always lock on a private readonly object, keep the locked section as small as possible for better performance.</li>
                </ul>
            </div>
        </div>

        <!-- Scenario Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="h6 mb-0 fw-bold">üìã Scenario</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="small text-muted mb-1">Available Tickets</div>
                            <div class="h4 fw-bold text-info mb-0">1</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="small text-muted mb-1">Concurrent Buyers</div>
                            <div class="h4 fw-bold text-info mb-0">@_buyerCount</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="small text-muted mb-1">Each Buyer</div>
                            <div class="small text-info mb-0">Read ‚Üí Check ‚Üí Wait 10ms ‚Üí Decrement</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <label for="buyers" class="form-label mb-1">Number of Buyers: <span class="text-primary-custom fw-bold">@_buyerCount</span></label>
                        <input type="range" class="form-range" id="buyers" min="5" max="20" @bind="_buyerCount" @bind:event="oninput" disabled="@_isRunning" />
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex gap-2">
                            <button class="btn btn-danger" @onclick="RunWithoutLock" disabled="@_isRunning">
                                ‚ùå Run WITHOUT Lock
                            </button>
                            <button class="btn btn-success" @onclick="RunWithLock" disabled="@_isRunning">
                                ‚úÖ Run WITH Lock
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        @if (_hasResult)
        {
            <div class="card mb-4 border-@(_lastUsedLock ? "success" : (_lastFinalTickets < 0 ? "danger" : "warning"))">
                <div class="card-header bg-@(_lastUsedLock ? "success" : (_lastFinalTickets < 0 ? "danger" : "warning")) bg-opacity-10">
                    <h3 class="h6 mb-0 fw-bold">üìä Results</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4 text-center">
                            <div class="small text-muted mb-1">Successful Purchases</div>
                            <div class="h3 fw-bold text-success mb-0">@_lastSuccessCount</div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="small text-muted mb-1">Failed Purchases</div>
                            <div class="h3 fw-bold text-secondary mb-0">@_lastFailCount</div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="small text-muted mb-1">Final Ticket Count</div>
                            <div class="h3 fw-bold @(_lastFinalTickets < 0 ? "text-danger" : "text-success") mb-0">@_lastFinalTickets</div>
                        </div>
                    </div>

                    @if (!_lastUsedLock && _lastFinalTickets < 0)
                    {
                        <div class="alert alert-danger mb-0">
                            <strong>‚ö†Ô∏è OVERSOLD by @(Math.Abs(_lastFinalTickets)) tickets!</strong><br/>
                            This is the race condition bug. Multiple threads read the same value before any decremented.
                        </div>
                    }
                    else if (_lastUsedLock && _lastFinalTickets == 0 && _lastSuccessCount == 1)
                    {
                        <div class="alert alert-success mb-0">
                            <strong>‚ú® Perfect!</strong> The lock prevented overselling. Only 1 buyer succeeded, exactly as expected.
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Execution Log -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="h6 mb-0 fw-bold">üìú Execution Log</h3>
                <button class="btn btn-sm btn-secondary" @onclick="ClearLog">Clear</button>
            </div>
            <div class="card-body p-0">
                <div class="p-3 bg-dark font-monospace small" style="max-height: 300px; overflow-y: auto;">
                    @if (TicketService.Log.Count == 0)
                    {
                        <p class="text-muted text-center mb-0">Run a simulation to see the execution log...</p>
                    }
                    else
                    {
                        @foreach (var entry in TicketService.Log)
                        {
                            <div class="@GetLogEntryClass(entry) py-1">@entry</div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- How it Works Section with Code Examples -->
        <div class="card">
            <div class="card-header">
                <h3 class="h6 mb-0 fw-bold">üìñ How it Works</h3>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- The Problem -->
                    <div class="col-12">
                        <div class="border-start border-danger border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-danger mb-0">1Ô∏è‚É£ The Problem - Race Condition</h4>
                                <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#raceCode1" aria-expanded="false" aria-controls="raceCode1">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                Multiple threads access shared data simultaneously without synchronization
                            </p>
                            <div class="collapse" id="raceCode1">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// ‚ùå UNSAFE - Race Condition
private int tickets = 1;

public void BuyTicket()
{
    // Thread 1 reads: tickets = 1 ‚úÖ
    // Thread 2 reads: tickets = 1 ‚úÖ (BOTH see 1!)
    if (tickets &gt; 0)
    {
        Thread.Sleep(10); // Simulate network latency
        
        // Thread 1 decrements: tickets = 0
        // Thread 2 ALSO decrements: tickets = -1 üí•
        tickets--;
    }
}

// Result: OVERSOLD! tickets = -1
// Both threads thought they could buy!</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- The Solution -->
                    <div class="col-12">
                        <div class="border-start border-success border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-success mb-0">2Ô∏è‚É£ The Solution - Lock Statement</h4>
                                <button class="btn btn-sm btn-outline-success" type="button" data-bs-toggle="collapse" data-bs-target="#raceCode2" aria-expanded="false" aria-controls="raceCode2">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                Lock ensures only one thread can access the critical section at a time
                            </p>
                            <div class="collapse" id="raceCode2">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// ‚úÖ SAFE - With Lock
private int tickets = 1;
private readonly object _lockObject = new();

public void BuyTicket()
{
    lock (_lockObject)  // Only one thread at a time!
    {
        // Thread 1 enters, Thread 2 WAITS
        if (tickets &gt; 0)
        {
            Thread.Sleep(10);
            tickets--;  // Thread 1: tickets = 0
        }
        // Thread 1 exits lock
        
        // NOW Thread 2 can enter
        // Thread 2 sees tickets = 0, cannot buy ‚úÖ
    }
}

// Result: Perfect! tickets = 0
// Only 1 ticket sold, as expected</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Best Practices -->
                    <div class="col-12">
                        <div class="border-start border-info border-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="h6 fw-bold text-info mb-0">3Ô∏è‚É£ Best Practices</h4>
                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#raceCode3" aria-expanded="false" aria-controls="raceCode3">
                                    View Code
                                </button>
                            </div>
                            <p class="small text-secondary-custom mb-2">
                                Always use a private readonly object for locking
                            </p>
                            <div class="collapse" id="raceCode3">
                                <div class="bg-dark rounded p-3 mt-2">
                                    <pre class="mb-0"><code class="text-white-50 small">// ‚úÖ GOOD: Private readonly lock object
private readonly object _lockObject = new();

lock (_lockObject)
{
    // Critical section
}

// ‚ùå BAD: Don't lock on 'this'
lock (this) { } // External code can lock on your instance!

// ‚ùå BAD: Don't lock on a Type
lock (typeof(MyClass)) { } // Locks across all instances!

// ‚ùå BAD: Don't lock on strings
lock ("myLock") { } // String interning can cause issues!

// üí° Keep the locked section as SMALL as possible
// Only protect the critical shared data access</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mt-3 mb-0">
                    <strong>‚ö†Ô∏è Key Takeaway:</strong> Race conditions occur when multiple threads access shared mutable state without synchronization. Always use locks to protect critical sections!
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int _buyerCount = 10;
    private bool _isRunning;
    private bool _hasResult;
    private int _lastSuccessCount;
    private int _lastFailCount;
    private int _lastFinalTickets;
    private bool _lastUsedLock;

    private async Task RunWithoutLock()
    {
        await RunSimulation(useLocking: false);
    }

    private async Task RunWithLock()
    {
        await RunSimulation(useLocking: true);
    }

    private async Task RunSimulation(bool useLocking)
    {
        _isRunning = true;
        StateHasChanged();

        await Task.Delay(50);

        await Task.Run(() =>
        {
            var (success, fail, final) = TicketService.SimulateConcurrentPurchases(_buyerCount, useLocking);
            _lastSuccessCount = success;
            _lastFailCount = fail;
            _lastFinalTickets = final;
            _lastUsedLock = useLocking;
            _hasResult = true;
        });

        _isRunning = false;
        StateHasChanged();
    }

    private void ClearLog()
    {
        TicketService.Reset(1);
        _hasResult = false;
        StateHasChanged();
    }

    private string GetLogEntryClass(string entry)
    {
        if (entry.Contains("‚úÖ")) return "text-success";
        if (entry.Contains("‚ùå")) return "text-danger";
        if (entry.Contains("‚ö†Ô∏è")) return "text-warning";
        if (entry.Contains("üîí")) return "text-info";
        return "text-secondary";
    }
}
