@page "/demos/race-condition"
@using Demo_C_.Services
@inject TicketService TicketService
@rendermode InteractiveServer

<PageTitle>Race Condition Demo</PageTitle>

<div class="demo-page">
    <h1>üîí Race Condition & Locking Demo</h1>
    <p class="description">
        Visualize what happens when multiple threads try to access shared resources simultaneously.
        This demonstrates the classic "double-booking" or "overselling" problem.
    </p>

    <div class="interview-question">
        <span class="label">üéØ Interview Question:</span>
        <span class="question">"Two users try to buy the last ticket at the exact same millisecond. How do you prevent selling it twice?"</span>
    </div>

    <div class="scenario-panel">
        <h3>üìã Scenario</h3>
        <div class="scenario-details">
            <div class="scenario-item">
                <span class="scenario-label">Available Tickets:</span>
                <span class="scenario-value">1</span>
            </div>
            <div class="scenario-item">
                <span class="scenario-label">Concurrent Buyers:</span>
                <span class="scenario-value">@_buyerCount</span>
            </div>
            <div class="scenario-item">
                <span class="scenario-label">Each buyer:</span>
                <span class="scenario-value">Reads ‚Üí Checks ‚Üí Waits 10ms ‚Üí Decrements</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Number of Buyers:</label>
            <input type="range" min="5" max="20" @bind="_buyerCount" @bind:event="oninput" disabled="@_isRunning" />
            <span class="control-value">@_buyerCount</span>
        </div>

        <div class="button-group">
            <button class="btn btn-danger" @onclick="RunWithoutLock" disabled="@_isRunning">
                ‚ùå Run WITHOUT Lock
            </button>
            <button class="btn btn-success" @onclick="RunWithLock" disabled="@_isRunning">
                ‚úÖ Run WITH Lock
            </button>
        </div>
    </div>

    @if (_hasResult)
    {
        <div class="results-panel @(_lastUsedLock ? "success" : (_lastFinalTickets < 0 ? "danger" : "warning"))">
            <h3>üìä Results</h3>
            <div class="results-grid">
                <div class="result-item">
                    <span class="result-label">Successful Purchases</span>
                    <span class="result-value success">@_lastSuccessCount</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Failed Purchases</span>
                    <span class="result-value neutral">@_lastFailCount</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Final Ticket Count</span>
                    <span class="result-value @(_lastFinalTickets < 0 ? "danger" : "success")">@_lastFinalTickets</span>
                </div>
            </div>

            @if (!_lastUsedLock && _lastFinalTickets < 0)
            {
                <div class="result-alert danger">
                    ‚ö†Ô∏è <strong>OVERSOLD by @(Math.Abs(_lastFinalTickets)) tickets!</strong> 
                    This is the race condition bug. Multiple threads read the same value before any decremented.
                </div>
            }
            else if (_lastUsedLock && _lastFinalTickets == 0 && _lastSuccessCount == 1)
            {
                <div class="result-alert success">
                    ‚ú® <strong>Perfect!</strong> The lock prevented overselling. 
                    Only 1 buyer succeeded, exactly as expected.
                </div>
            }
        </div>
    }

    <div class="log-panel">
        <div class="log-header">
            <h3>üìú Execution Log</h3>
            <button class="btn-clear" @onclick="ClearLog">Clear</button>
        </div>
        <div class="log-content">
            @if (TicketService.Log.Count == 0)
            {
                <p class="log-empty">Run a simulation to see the execution log...</p>
            }
            else
            {
                @foreach (var entry in TicketService.Log)
                {
                    <div class="log-entry @GetLogEntryClass(entry)">@entry</div>
                }
            }
        </div>
    </div>

    <div class="info-panel">
        <h3>üìñ The Fix: Using Locks</h3>
        <div class="code-comparison">
            <div class="code-block danger">
                <h4>‚ùå Unsafe (Race Condition)</h4>
                <pre><code>if (tickets > 0)
{
    Thread.Sleep(10); // Latency
    tickets--;        // BUG: Others may have decremented!
}</code></pre>
            </div>
            <div class="code-block success">
                <h4>‚úÖ Safe (With Lock)</h4>
                <pre><code>lock (_lockObject)
{
    if (tickets > 0)
    {
        Thread.Sleep(10);
        tickets--;    // Only one thread at a time
    }
}</code></pre>
            </div>
        </div>
    </div>
</div>

@code {
    private int _buyerCount = 10;
    private bool _isRunning;
    private bool _hasResult;
    private int _lastSuccessCount;
    private int _lastFailCount;
    private int _lastFinalTickets;
    private bool _lastUsedLock;

    private async Task RunWithoutLock()
    {
        await RunSimulation(useLocking: false);
    }

    private async Task RunWithLock()
    {
        await RunSimulation(useLocking: true);
    }

    private async Task RunSimulation(bool useLocking)
    {
        _isRunning = true;
        StateHasChanged();

        await Task.Delay(50); // Let UI update

        await Task.Run(() =>
        {
            var (success, fail, final) = TicketService.SimulateConcurrentPurchases(_buyerCount, useLocking);
            _lastSuccessCount = success;
            _lastFailCount = fail;
            _lastFinalTickets = final;
            _lastUsedLock = useLocking;
            _hasResult = true;
        });

        _isRunning = false;
        StateHasChanged();
    }

    private void ClearLog()
    {
        TicketService.Reset(1);
        _hasResult = false;
        StateHasChanged();
    }

    private string GetLogEntryClass(string entry)
    {
        if (entry.Contains("‚úÖ")) return "log-success";
        if (entry.Contains("‚ùå")) return "log-error";
        if (entry.Contains("‚ö†Ô∏è")) return "log-warning";
        if (entry.Contains("üîí")) return "log-lock";
        return "";
    }
}

<style>
    .demo-page {
        padding: 1.5rem;
        max-width: 1000px;
        margin: 0 auto;
    }

    .demo-page h1 {
        color: #00ff88;
        margin-bottom: 0.5rem;
    }

    .description {
        color: #888;
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    .interview-question {
        background: rgba(168, 85, 247, 0.15);
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-radius: 8px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }

    .interview-question .label {
        color: #a855f7;
        font-weight: 600;
        margin-right: 0.5rem;
    }

    .interview-question .question {
        color: #ccc;
        font-style: italic;
    }

    .scenario-panel {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .scenario-panel h3 {
        margin: 0 0 1rem 0;
        color: #fff;
        font-size: 1rem;
    }

    .scenario-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .scenario-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .scenario-label {
        color: #666;
        font-size: 0.85rem;
    }

    .scenario-value {
        color: #4ecdc4;
        font-weight: 600;
    }

    .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        align-items: flex-end;
        margin-bottom: 1.5rem;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .control-group label {
        color: #888;
        font-size: 0.9rem;
    }

    .control-group input[type="range"] {
        width: 120px;
    }

    .control-value {
        color: #00ff88;
        font-weight: 600;
        min-width: 30px;
    }

    .button-group {
        display: flex;
        gap: 0.75rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-danger {
        background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        color: white;
    }

    .btn-success {
        background: linear-gradient(135deg, #00ff88, #00cc6a);
        color: #1a1a2e;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .results-panel {
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .results-panel.danger {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .results-panel.success {
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .results-panel.warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .results-panel h3 {
        margin: 0 0 1rem 0;
        color: #fff;
        font-size: 1rem;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .result-item {
        text-align: center;
    }

    .result-label {
        display: block;
        color: #888;
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    .result-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .result-value.success { color: #00ff88; }
    .result-value.danger { color: #ff6b6b; }
    .result-value.neutral { color: #888; }

    .result-alert {
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .result-alert.danger {
        background: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
    }

    .result-alert.success {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
    }

    .log-panel {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .log-header h3 {
        margin: 0;
        color: #fff;
        font-size: 1rem;
    }

    .btn-clear {
        padding: 0.35rem 0.75rem;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        color: #888;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .btn-clear:hover {
        background: rgba(255, 255, 255, 0.05);
        color: #ccc;
    }

    .log-content {
        max-height: 300px;
        overflow-y: auto;
        padding: 1rem 1.25rem;
        font-family: 'Consolas', monospace;
        font-size: 0.85rem;
    }

    .log-empty {
        color: #555;
        text-align: center;
        margin: 0;
    }

    .log-entry {
        padding: 0.25rem 0;
        color: #aaa;
    }

    .log-entry.log-success { color: #00ff88; }
    .log-entry.log-error { color: #ff6b6b; }
    .log-entry.log-warning { color: #f59e0b; }
    .log-entry.log-lock { color: #a855f7; }

    .info-panel {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1.25rem;
    }

    .info-panel h3 {
        color: #00ff88;
        margin: 0 0 1rem 0;
        font-size: 1rem;
    }

    .code-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }

    .code-block {
        border-radius: 8px;
        overflow: hidden;
    }

    .code-block.danger {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.2);
    }

    .code-block.success {
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.2);
    }

    .code-block h4 {
        margin: 0;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .code-block.danger h4 { color: #ff6b6b; }
    .code-block.success h4 { color: #00ff88; }

    .code-block pre {
        margin: 0;
        padding: 1rem;
        overflow-x: auto;
    }

    .code-block code {
        font-family: 'Consolas', monospace;
        font-size: 0.85rem;
        color: #ccc;
    }
</style>
